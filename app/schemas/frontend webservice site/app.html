<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ™ Ramadan Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ramadan-gold': '#D4AF37',
                        'ramadan-purple': '#4A1A6B',
                        'ramadan-green': '#0D5C2E',
                        'ramadan-night': '#1A1A2E',
                        'ramadan-dark': '#16213E',
                    },
                    fontFamily: {
                        'arabic': ['Amiri', 'serif'],
                        'poppins': ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        .hidden { display: none !important; }
        .arabic-text { font-family: 'Amiri', serif; }
        .gold-glow { box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); }
        .card-hover:hover { transform: translateY(-5px); transition: all 0.3s ease; }
        input, textarea, select { 
            background-color: white !important; 
            color: #1a1a2e !important; 
        }
        input::placeholder, textarea::placeholder { color: #6b7280 !important; }
    </style>
</head>
<body class="bg-ramadan-night min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gradient-to-r from-ramadan-purple via-ramadan-dark to-ramadan-night text-white shadow-lg sticky top-0 z-50 border-b border-ramadan-gold/30">
        <div class="container mx-auto flex justify-between items-center py-4 px-4">
            <a href="#" onclick="showPage('home')" class="text-2xl font-bold cursor-pointer hover:text-ramadan-gold transition-colors">
                <span class="text-ramadan-gold">â˜ª</span> Ramadan Helper
            </a>
            <nav class="hidden md:flex gap-6 items-center">
                <button onclick="showPage('home')" class="hover:text-ramadan-gold transition-colors">Home</button>
                <button onclick="showPage('analyzer')" class="hover:text-ramadan-gold transition-colors font-bold text-ramadan-gold">âœ¨ Ask AI</button>
                <button onclick="showPage('dua')" class="hover:text-ramadan-gold transition-colors">ğŸ“¿ Dua</button>
                <button onclick="showPage('videos')" class="hover:text-ramadan-gold transition-colors">ğŸ“º Videos</button>
                <button onclick="showPage('chat')" class="hover:text-ramadan-gold transition-colors">ğŸ’¬ Chat</button>
                <button onclick="showPage('events')" class="hover:text-ramadan-gold transition-colors font-bold text-green-400">ğŸª Events</button>
            </nav>
        </div>
    </header>

    <!-- Login Modal -->
    <div id="loginModal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26,26,46,0.95); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
        <div style="background: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%); border-radius: 16px; padding: 40px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 1px solid rgba(212,175,55,0.3); margin: auto;">
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="font-size: 48px; margin-bottom: 10px;">â˜ªï¸</div>
                <h1 style="color: #D4AF37; font-size: 28px; font-weight: bold; margin: 0;">Ramadan Helper</h1>
                <p style="color: #9CA3AF; margin-top: 8px;">Your Islamic Companion</p>
            </div>
            
            <!-- Initial Selection: Login or Signup -->
            <div id="loginTypeSelection">
                <button id="btnUserLogin" style="display: block; width: 100%; padding: 16px; margin-bottom: 12px; background: linear-gradient(135deg, #D4AF37, #B8860B); color: #1A1A2E; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer;">
                    ğŸ‘¤ Login as User
                </button>
                <button id="btnUserSignup" style="display: block; width: 100%; padding: 16px; margin-bottom: 12px; background: linear-gradient(135deg, #0D5C2E, #166534); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer;">
                    âœ¨ Create New Account
                </button>
                <button id="btnImamLogin" style="display: block; width: 100%; padding: 16px; background: linear-gradient(135deg, #4A1A6B, #6B21A8); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer;">
                    ğŸ•Œ Login as Imam
                </button>
            </div>
            
            <!-- User Login Form -->
            <div id="userLoginForm" style="display: none;">
                <h3 style="color: #D4AF37; font-size: 20px; font-weight: bold; margin-bottom: 20px;">ğŸ‘¤ User Login</h3>
                <input type="email" id="userEmailInput" placeholder="your.email@example.com" style="width: 100%; padding: 14px; border: 2px solid #D4AF37; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 12px; background: white; color: #1A1A2E;">
                <p id="userEmailError" style="color: #dc2626; font-size: 12px; margin-bottom: 8px; display: none;"></p>
                <input type="password" id="userPasswordInput" placeholder="Password" style="width: 100%; padding: 14px; border: 2px solid #D4AF37; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 16px; background: white; color: #1A1A2E;">
                <button id="btnSubmitUserLogin" style="display: block; width: 100%; padding: 16px; margin-bottom: 12px; background: linear-gradient(135deg, #D4AF37, #B8860B); color: #1A1A2E; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer;">âœ“ Login</button>
                <p style="text-align: center; color: #9CA3AF; margin: 12px 0;">
                    <a href="#" onclick="showForgotPassword()" style="color: #D4AF37; text-decoration: underline;">Forgot Password?</a>
                </p>
                <button id="btnBackFromUser" style="display: block; width: 100%; padding: 14px; background: rgba(255,255,255,0.1); color: #9CA3AF; border: 1px solid rgba(212,175,55,0.3); border-radius: 10px; font-size: 16px; cursor: pointer;">â† Back</button>
                <div id="userLoginStatus" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>
            </div>
            
            <!-- User Signup Form -->
            <div id="userSignupForm" style="display: none;">
                <h3 style="color: #0D5C2E; font-size: 20px; font-weight: bold; margin-bottom: 20px;">âœ¨ Create New Account</h3>
                <input type="text" id="signupNameInput" placeholder="Your Full Name" style="width: 100%; padding: 14px; border: 2px solid #0D5C2E; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 12px; background: white; color: #1A1A2E;">
                <input type="email" id="signupEmailInput" placeholder="your.email@example.com" style="width: 100%; padding: 14px; border: 2px solid #0D5C2E; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 12px; background: white; color: #1A1A2E;">
                <div id="emailValidationStatus" style="display: none; margin-bottom: 12px; padding: 8px; border-radius: 6px; font-size: 13px;"></div>
                <input type="password" id="signupPasswordInput" placeholder="Password (min 8 chars, letter + number)" style="width: 100%; padding: 14px; border: 2px solid #0D5C2E; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 8px; background: white; color: #1A1A2E;">
                <div id="passwordStrength" style="margin-bottom: 12px; font-size: 12px; color: #9CA3AF;"></div>
                <input type="password" id="signupConfirmPassword" placeholder="Confirm Password" style="width: 100%; padding: 14px; border: 2px solid #0D5C2E; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 16px; background: white; color: #1A1A2E;">
                <button id="btnSubmitSignup" style="display: block; width: 100%; padding: 16px; margin-bottom: 12px; background: linear-gradient(135deg, #0D5C2E, #166534); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer;">âœ¨ Create Account</button>
                <p style="text-align: center; color: #9CA3AF; margin: 12px 0;">
                    Already have an account? <a href="#" onclick="showUserLoginFromSignup()" style="color: #D4AF37; text-decoration: underline;">Login</a>
                </p>
                <button id="btnBackFromSignup" style="display: block; width: 100%; padding: 14px; background: rgba(255,255,255,0.1); color: #9CA3AF; border: 1px solid rgba(13,92,46,0.3); border-radius: 10px; font-size: 16px; cursor: pointer;">â† Back</button>
                <div id="signupStatus" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>
            </div>
            
            <!-- Forgot Password Form -->
            <div id="forgotPasswordForm" style="display: none;">
                <h3 style="color: #D4AF37; font-size: 20px; font-weight: bold; margin-bottom: 20px;">ğŸ”‘ Reset Password</h3>
                <p style="color: #9CA3AF; margin-bottom: 16px; font-size: 14px;">Enter your email address and we'll send you a reset link.</p>
                <input type="email" id="resetEmailInput" placeholder="your.email@example.com" style="width: 100%; padding: 14px; border: 2px solid #D4AF37; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 16px; background: white; color: #1A1A2E;">
                <button id="btnSubmitReset" style="display: block; width: 100%; padding: 16px; margin-bottom: 12px; background: linear-gradient(135deg, #D4AF37, #B8860B); color: #1A1A2E; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer;">ğŸ“§ Send Reset Link</button>
                <button onclick="showUserLoginFromReset()" style="display: block; width: 100%; padding: 14px; background: rgba(255,255,255,0.1); color: #9CA3AF; border: 1px solid rgba(212,175,55,0.3); border-radius: 10px; font-size: 16px; cursor: pointer;">â† Back to Login</button>
                <div id="resetStatus" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>
            </div>
            
            <!-- Imam Login Form -->
            <div id="imamLoginForm" style="display: none;">
                <h3 style="color: #A855F7; font-size: 20px; font-weight: bold; margin-bottom: 20px;">ğŸ•Œ Imam Login</h3>
                <input type="text" id="imamNameInput" placeholder="Your full name" style="width: 100%; padding: 14px; border: 2px solid #A855F7; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 12px; background: white; color: #1A1A2E;">
                <input type="email" id="imamEmailInput" placeholder="your.email@example.com" style="width: 100%; padding: 14px; border: 2px solid #A855F7; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 12px; background: white; color: #1A1A2E;">
                <input type="password" id="imamPasswordInput" placeholder="Password" style="width: 100%; padding: 14px; border: 2px solid #A855F7; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 16px; background: white; color: #1A1A2E;">
                <button id="btnSubmitImamLogin" style="display: block; width: 100%; padding: 16px; margin-bottom: 12px; background: linear-gradient(135deg, #4A1A6B, #6B21A8); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer;">âœ“ Login as Imam</button>
                <p style="text-align: center; color: #9CA3AF; margin: 12px 0;">
                    New Imam? <a href="#" onclick="showImamSignup()" style="color: #A855F7; text-decoration: underline;">Register here</a>
                </p>
                <button id="btnBackFromImam" style="display: block; width: 100%; padding: 14px; background: rgba(255,255,255,0.1); color: #9CA3AF; border: 1px solid rgba(168,85,247,0.3); border-radius: 10px; font-size: 16px; cursor: pointer;">â† Back</button>
                <div id="imamLoginStatus" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>
            </div>
            
            <!-- Imam Signup Form -->
            <div id="imamSignupForm" style="display: none;">
                <h3 style="color: #A855F7; font-size: 20px; font-weight: bold; margin-bottom: 20px;">ğŸ•Œ Imam Registration</h3>
                <input type="text" id="imamSignupName" placeholder="Your Full Name" style="width: 100%; padding: 14px; border: 2px solid #A855F7; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 12px; background: white; color: #1A1A2E;">
                <input type="email" id="imamSignupEmail" placeholder="your.email@example.com" style="width: 100%; padding: 14px; border: 2px solid #A855F7; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 12px; background: white; color: #1A1A2E;">
                <input type="text" id="imamSignupExpertise" placeholder="Area of Expertise (e.g., Quran, Hadith, Fiqh)" style="width: 100%; padding: 14px; border: 2px solid #A855F7; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 12px; background: white; color: #1A1A2E;">
                <input type="password" id="imamSignupPassword" placeholder="Password (min 8 chars)" style="width: 100%; padding: 14px; border: 2px solid #A855F7; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 12px; background: white; color: #1A1A2E;">
                <input type="password" id="imamSignupConfirm" placeholder="Confirm Password" style="width: 100%; padding: 14px; border: 2px solid #A855F7; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-bottom: 16px; background: white; color: #1A1A2E;">
                <button id="btnSubmitImamSignup" style="display: block; width: 100%; padding: 16px; margin-bottom: 12px; background: linear-gradient(135deg, #4A1A6B, #6B21A8); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer;">âœ¨ Register as Imam</button>
                <button onclick="showImamLoginFromSignup()" style="display: block; width: 100%; padding: 14px; background: rgba(255,255,255,0.1); color: #9CA3AF; border: 1px solid rgba(168,85,247,0.3); border-radius: 10px; font-size: 16px; cursor: pointer;">â† Back to Login</button>
                <div id="imamSignupStatus" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>
            </div>
            
            <!-- Email Verification Pending Screen -->
            <div id="verificationPendingScreen" style="display: none;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="font-size: 64px; margin-bottom: 10px;">ğŸ“§</div>
                    <h3 style="color: #0D5C2E; font-size: 24px; font-weight: bold; margin-bottom: 10px;">Check Your Email!</h3>
                    <p style="color: #9CA3AF; font-size: 14px;">We've sent a verification link to:</p>
                    <p id="pendingEmailDisplay" style="color: #D4AF37; font-size: 18px; font-weight: bold; margin: 10px 0;"></p>
                </div>
                
                <div style="background: rgba(13, 92, 46, 0.2); padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0D5C2E;">
                    <p style="color: #22c55e; font-size: 14px; margin: 0;">
                        ğŸ“¬ Click the link in your email to verify your account and start using Ramadan Helper.
                    </p>
                </div>
                
                <p style="color: #9CA3AF; font-size: 13px; text-align: center; margin-bottom: 16px;">
                    Didn't receive the email? Check your spam folder or click below to resend.
                </p>
                
                <button onclick="resendVerificationEmail()" id="resendVerifyBtn" style="display: block; width: 100%; padding: 14px; margin-bottom: 12px; background: linear-gradient(135deg, #D4AF37, #B8860B); color: #1A1A2E; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;">ğŸ“§ Resend Verification Email</button>
                
                <div style="text-align: center; margin: 16px 0;">
                    <span style="color: #9CA3AF;">â€” OR â€”</span>
                </div>
                
                <p style="color: #9CA3AF; font-size: 13px; text-align: center; margin-bottom: 12px;">
                    Already have the verification code? Enter it here:
                </p>
                
                <input type="text" id="manualVerifyToken" placeholder="Paste verification token here" style="width: 100%; padding: 14px; border: 2px solid #0D5C2E; border-radius: 8px; font-size: 14px; box-sizing: border-box; margin-bottom: 12px; background: white; color: #1A1A2E;">
                <button onclick="verifyEmailManually()" style="display: block; width: 100%; padding: 14px; margin-bottom: 20px; background: linear-gradient(135deg, #0D5C2E, #166534); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;">âœ“ Verify Email</button>
                
                <button onclick="backToLoginSelection()" style="display: block; width: 100%; padding: 14px; background: rgba(255,255,255,0.1); color: #9CA3AF; border: 1px solid rgba(212,175,55,0.3); border-radius: 10px; font-size: 16px; cursor: pointer;">â† Back to Login</button>
                
                <div id="verifyStatus" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>
                
                <!-- Demo mode token display -->
                <div id="demoTokenDisplay" style="display: none; margin-top: 20px; background: rgba(234, 179, 8, 0.2); padding: 16px; border-radius: 8px; border: 1px solid rgba(234, 179, 8, 0.5);">
                    <p style="color: #eab308; font-size: 12px; margin-bottom: 8px;">âš ï¸ Demo Mode: SMTP not configured. Use this token to verify:</p>
                    <code id="demoToken" style="display: block; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; color: #D4AF37; font-size: 11px; word-break: break-all;"></code>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Header -->
    <div id="userProfileHeader" class="hidden bg-gradient-to-r from-ramadan-purple to-ramadan-dark text-white py-3 px-4 border-b border-ramadan-gold/30">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <span id="userTypeDisplay" class="text-ramadan-gold"></span>
                <span id="userNameDisplay" class="font-semibold"></span>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="showProfileModal()" class="px-3 py-2 bg-white/10 text-white font-semibold rounded hover:bg-white/20 transition-colors">âš™ï¸ Profile</button>
                <button onclick="logout()" class="px-4 py-2 bg-ramadan-gold text-ramadan-night font-semibold rounded hover:bg-yellow-500 transition-colors">Logout</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-ramadan-dark rounded-lg p-8 max-w-md w-full border border-ramadan-gold/30">
            <h2 class="text-2xl font-bold text-ramadan-gold mb-6">âš™ï¸ Account Settings</h2>
            
            <div class="mb-6">
                <h3 class="font-semibold text-white mb-3">ğŸ‘¤ Profile Information</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Name</label>
                        <input type="text" id="profileName" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Email</label>
                        <input type="email" id="profileEmail" readonly class="w-full px-4 py-2 bg-gray-800 border border-gray-600 text-gray-400 rounded-lg cursor-not-allowed">
                    </div>
                </div>
                <button onclick="updateProfile()" class="mt-4 px-4 py-2 bg-ramadan-gold text-ramadan-night font-semibold rounded-lg hover:bg-yellow-500">Save Changes</button>
            </div>
            
            <div class="border-t border-gray-700 pt-6 mb-6">
                <h3 class="font-semibold text-white mb-3">ğŸ” Change Password</h3>
                <div class="space-y-3">
                    <input type="password" id="currentPassword" placeholder="Current Password" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg">
                    <input type="password" id="newPassword" placeholder="New Password (min 8 chars)" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg">
                    <input type="password" id="confirmNewPassword" placeholder="Confirm New Password" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-lg">
                </div>
                <button onclick="changePassword()" class="mt-4 px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-500">Change Password</button>
            </div>
            
            <div id="profileStatus" class="hidden mb-4 p-3 rounded-lg"></div>
            
            <button onclick="hideProfileModal()" class="w-full px-4 py-3 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500">Close</button>
        </div>
    </div>

    <!-- HOME PAGE -->
    <div id="home" class="page active">
        <main class="container mx-auto py-12 px-4 flex-grow">
            <div id="backendStatus" class="mb-6 text-center">
                <div class="inline-flex items-center gap-3">
                    <div id="statusIndicator" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-ramadan-dark/50 text-ramadan-gold border border-ramadan-gold/30">
                        <span class="animate-pulse">â—</span> Checking services...
                    </div>
                    <button onclick="checkBackendStatus()" class="px-3 py-2 bg-ramadan-gold/20 hover:bg-ramadan-gold/30 text-ramadan-gold rounded-lg border border-ramadan-gold/30 transition-colors" title="Refresh Status">ğŸ”„</button>
                </div>
            </div>
            
            <div class="text-center mb-12">
                <h1 class="text-5xl font-bold text-ramadan-gold mb-4">â˜ªï¸ Welcome to Ramadan Helper</h1>
                <p class="text-xl text-gray-300 mb-8">Your personal Islamic companion for duas, guidance, and spiritual connection</p>
                
                <div class="flex gap-4 justify-center mb-8 flex-wrap">
                    <button onclick="showPage('analyzer')" class="px-8 py-4 bg-gradient-to-r from-ramadan-gold to-yellow-600 text-ramadan-night font-bold rounded-xl hover:from-yellow-500 hover:to-yellow-600 shadow-lg text-lg gold-glow card-hover">ğŸ¤– Ask AI</button>
                    <button onclick="showPage('dua')" class="px-8 py-4 bg-gradient-to-r from-ramadan-green to-emerald-700 text-white font-bold rounded-xl hover:from-emerald-600 hover:to-emerald-700 shadow-lg text-lg card-hover">ğŸ“¿ Generate Dua</button>
                    <button onclick="showPage('videos')" class="px-8 py-4 bg-gradient-to-r from-red-600 to-red-700 text-white font-bold rounded-xl hover:from-red-500 hover:to-red-600 shadow-lg text-lg card-hover">ğŸ“º Islamic Videos</button>
                    <button onclick="showPage('chat')" class="px-8 py-4 bg-gradient-to-r from-ramadan-purple to-purple-700 text-white font-bold rounded-xl hover:from-purple-600 hover:to-purple-700 shadow-lg text-lg card-hover">ğŸ’¬ Chat with Imam</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                <div onclick="showPage('analyzer')" class="bg-gradient-to-br from-ramadan-dark to-ramadan-night rounded-lg shadow-lg p-6 hover:shadow-xl cursor-pointer border border-ramadan-gold/30 card-hover">
                    <div class="text-4xl mb-4">ğŸ¤–</div>
                    <h2 class="text-2xl font-bold text-ramadan-gold mb-3">Ask AI</h2>
                    <p class="text-gray-400">Get Quran ayahs & Hadiths with AI-powered explanations</p>
                    <span class="inline-block mt-3 px-3 py-1 bg-ramadan-gold/20 text-ramadan-gold rounded-full text-sm font-semibold">âœ¨ AI Powered</span>
                </div>

                <div onclick="showPage('dua')" class="bg-gradient-to-br from-ramadan-dark to-ramadan-night rounded-lg shadow-lg p-6 hover:shadow-xl cursor-pointer border border-ramadan-green/30 card-hover">
                    <div class="text-4xl mb-4">ğŸ“¿</div>
                    <h2 class="text-2xl font-bold text-ramadan-green mb-3">Dua Generator</h2>
                    <p class="text-gray-400">Get personalized duas in English and Arabic</p>
                    <span class="inline-block mt-3 px-3 py-1 bg-ramadan-green/20 text-green-400 rounded-full text-sm font-semibold">âœ¨ Bilingual</span>
                </div>

                <div onclick="showPage('videos')" class="bg-gradient-to-br from-ramadan-dark to-ramadan-night rounded-lg shadow-lg p-6 hover:shadow-xl cursor-pointer border border-red-500/30 card-hover">
                    <div class="text-4xl mb-4">ğŸ“º</div>
                    <h2 class="text-2xl font-bold text-red-400 mb-3">Islamic Videos</h2>
                    <p class="text-gray-400">Find Islamic videos on YouTube</p>
                    <span class="inline-block mt-3 px-3 py-1 bg-red-500/20 text-red-400 rounded-full text-sm font-semibold">YouTube</span>
                </div>

                <div onclick="showPage('chat')" class="bg-gradient-to-br from-ramadan-dark to-ramadan-night rounded-lg shadow-lg p-6 hover:shadow-xl cursor-pointer border border-ramadan-purple/50 card-hover">
                    <div class="text-4xl mb-4">ğŸ’¬</div>
                    <h2 class="text-2xl font-bold text-purple-400 mb-3">Chat with Imam</h2>
                    <p class="text-gray-400">Have a private conversation with a real Imam</p>
                    <span class="inline-block mt-3 px-3 py-1 bg-purple-500/20 text-purple-400 rounded-full text-sm font-semibold">ğŸ•Œ Real Imam</span>
                </div>
            </div>

            <!-- Events Card -->
            <div onclick="showPage('events')" class="bg-gradient-to-r from-ramadan-green/20 to-ramadan-gold/20 rounded-lg shadow-lg p-8 mb-12 cursor-pointer border border-ramadan-gold/30 card-hover">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-ramadan-gold mb-2">ğŸª Ramadan Events in Tunisia</h2>
                        <p class="text-gray-300">Discover iftars, tarawih prayers, charity events & more across 24 cities</p>
                        <div class="mt-3 flex gap-4 flex-wrap">
                            <span class="px-3 py-1 bg-ramadan-gold/20 text-ramadan-gold rounded-full text-sm">ğŸ“ 24 Cities</span>
                            <span class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-sm">ğŸ’° Basic: 20 TND</span>
                            <span class="px-3 py-1 bg-purple-500/20 text-purple-400 rounded-full text-sm">â­ Featured: 50 TND</span>
                        </div>
                    </div>
                    <button class="px-6 py-3 bg-ramadan-gold text-ramadan-night font-bold rounded-lg hover:bg-yellow-500 transition-colors">ğŸª View Events</button>
                </div>
            </div>

            <div class="bg-gradient-to-r from-ramadan-purple/30 to-ramadan-dark rounded-lg p-8 border border-ramadan-gold/20">
                <h2 class="text-3xl font-bold text-ramadan-gold mb-4">About Ramadan Helper</h2>
                <p class="text-gray-300">Ramadan Helper is designed to support your spiritual journey. We combine Islamic scholarship with AI technology to provide personalized guidance, duas, and resources.</p>
            </div>
        </main>
    </div>

    <!-- EVENTS PAGE -->
    <div id="events" class="page">
        <main class="container mx-auto py-12 px-4">
            <h1 class="text-4xl font-bold text-ramadan-gold mb-4 text-center">ğŸª Ramadan Events in Tunisia</h1>
            <p class="text-center text-gray-400 mb-8">Discover and share Ramadan events across Tunisia</p>

            <!-- Filters -->
            <div class="bg-ramadan-dark/50 rounded-lg p-6 mb-8 border border-ramadan-gold/20">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-ramadan-gold mb-2">City</label>
                        <select id="eventCityFilter" class="w-full px-4 py-3 border-2 border-ramadan-gold/30 rounded-lg bg-white text-ramadan-night">
                            <option value="">All Cities</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-ramadan-gold mb-2">Category</label>
                        <select id="eventCategoryFilter" class="w-full px-4 py-3 border-2 border-ramadan-gold/30 rounded-lg bg-white text-ramadan-night">
                            <option value="">All Categories</option>
                            <option value="iftar">Iftar</option>
                            <option value="tarawih">Tarawih</option>
                            <option value="charity">Charity</option>
                            <option value="lecture">Lecture</option>
                            <option value="quran">Quran</option>
                            <option value="children">Children</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="filterEvents()" class="w-full px-6 py-3 bg-ramadan-gold text-ramadan-night font-bold rounded-lg hover:bg-yellow-500">ğŸ” Search</button>
                    </div>
                </div>
            </div>

            <!-- Featured Events -->
            <div id="featuredEventsSection" class="mb-8">
                <h2 class="text-2xl font-bold text-ramadan-gold mb-4">â­ Featured Events</h2>
                <div id="featuredEventsList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <p class="text-gray-400 col-span-2">No featured events yet</p>
                </div>
            </div>

            <!-- All Events -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-white mb-4">ğŸ“‹ All Events</h2>
                <div id="eventsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-gray-400">No events found. Be the first to post!</p>
                </div>
            </div>

            <!-- Post Event Button -->
            <div class="text-center">
                <button onclick="showPostEventModal()" class="px-8 py-4 bg-gradient-to-r from-ramadan-gold to-yellow-600 text-ramadan-night font-bold rounded-xl hover:from-yellow-500 hover:to-yellow-600 shadow-lg text-lg">
                    â• Post Your Event
                </button>
                <p class="text-gray-400 mt-2">Basic: 20 TND | Featured: 50 TND</p>
            </div>
        </main>
    </div>

    <!-- Post Event Modal -->
    <div id="postEventModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-ramadan-dark rounded-lg p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-ramadan-gold/30">
            <h2 class="text-2xl font-bold text-ramadan-gold mb-6">â• Post a Ramadan Event</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Event Title</label>
                    <input type="text" id="eventTitle" placeholder="e.g., Community Iftar" class="w-full px-4 py-3 border-2 border-ramadan-gold/30 rounded-lg bg-white text-ramadan-night">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">City</label>
                    <select id="eventCity" class="w-full px-4 py-3 border-2 border-ramadan-gold/30 rounded-lg bg-white text-ramadan-night"></select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Category</label>
                    <select id="eventCategory" class="w-full px-4 py-3 border-2 border-ramadan-gold/30 rounded-lg bg-white text-ramadan-night">
                        <option value="iftar">Iftar</option>
                        <option value="tarawih">Tarawih</option>
                        <option value="charity">Charity</option>
                        <option value="lecture">Lecture</option>
                        <option value="quran">Quran</option>
                        <option value="children">Children</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Date</label>
                    <input type="date" id="eventDate" class="w-full px-4 py-3 border-2 border-ramadan-gold/30 rounded-lg bg-white text-ramadan-night">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Time</label>
                    <input type="time" id="eventTime" class="w-full px-4 py-3 border-2 border-ramadan-gold/30 rounded-lg bg-white text-ramadan-night">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Location/Address</label>
                    <input type="text" id="eventLocation" placeholder="e.g., Zitouna Mosque, Medina" class="w-full px-4 py-3 border-2 border-ramadan-gold/30 rounded-lg bg-white text-ramadan-night">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Description</label>
                    <textarea id="eventDescription" rows="3" placeholder="Describe your event..." class="w-full px-4 py-3 border-2 border-ramadan-gold/30 rounded-lg bg-white text-ramadan-night resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Contact Phone (optional)</label>
                    <input type="tel" id="eventPhone" placeholder="+216 XX XXX XXX" class="w-full px-4 py-3 border-2 border-ramadan-gold/30 rounded-lg bg-white text-ramadan-night">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Listing Type</label>
                    <select id="eventListingType" class="w-full px-4 py-3 border-2 border-ramadan-gold/30 rounded-lg bg-white text-ramadan-night">
                        <option value="basic">Basic (20 TND)</option>
                        <option value="featured">Featured (50 TND) â­</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-4 mt-6">
                <button onclick="submitEvent()" class="flex-1 px-6 py-3 bg-ramadan-gold text-ramadan-night font-bold rounded-lg hover:bg-yellow-500">ğŸ“¤ Submit Event</button>
                <button onclick="hidePostEventModal()" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-500">Cancel</button>
            </div>
        </div>
    </div>

    <!-- DUA GENERATOR PAGE -->
    <div id="dua" class="page">
        <main class="container mx-auto py-12 px-4">
            <h1 class="text-4xl font-bold text-ramadan-gold mb-4 text-center">ğŸ“¿ Personalized Dua Generator</h1>
            <p class="text-center text-gray-400 mb-8">Generate meaningful duas tailored to your situation</p>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-6xl mx-auto">
                <div class="bg-gray-800/50 rounded-xl border border-gray-700 p-6">
                    <h2 class="text-2xl font-bold text-ramadan-gold mb-6">ğŸ¤² Tell us your need</h2>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Select Category</label>
                        <select id="duaCategory" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-white rounded-lg focus:border-ramadan-gold focus:ring-2 focus:ring-ramadan-gold/30 outline-none">
                            <option>Fear & Anxiety</option>
                            <option>Financial Hardship</option>
                            <option>Health Issues</option>
                            <option>Family Problems</option>
                            <option>Career Guidance</option>
                            <option>Spiritual Growth</option>
                            <option>Relationship Issues</option>
                        </select>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Your Situation</label>
                        <textarea id="duaContext" placeholder="Describe your situation in detail..." rows="5" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg resize-none focus:border-ramadan-gold focus:ring-2 focus:ring-ramadan-gold/30 outline-none"></textarea>
                    </div>

                    <button onclick="generateDua()" id="generateDuaBtn" class="w-full px-6 py-4 bg-gradient-to-r from-ramadan-gold to-yellow-500 text-ramadan-night font-bold rounded-lg hover:from-yellow-500 hover:to-ramadan-gold text-lg transition-all duration-300 transform hover:scale-105">ğŸ“¿ Generate My Dua</button>
                </div>

                <div id="duaOutput" class="hidden bg-gradient-to-br from-ramadan-purple/30 to-gray-800/50 rounded-xl border border-ramadan-gold/30 p-6">
                    <h2 class="text-2xl font-bold text-ramadan-gold mb-6">âœ¨ Your Personalized Dua</h2>

                    <div class="mb-6 p-4 bg-gray-800/50 rounded-lg border-l-4 border-ramadan-gold">
                        <h3 class="font-semibold text-ramadan-gold mb-2">ğŸ‡¬ğŸ‡§ English</h3>
                        <p id="duaEn" class="text-gray-200 text-lg italic"></p>
                    </div>

                    <div class="mb-6 p-4 bg-gray-800/50 rounded-lg border-l-4 border-blue-400 text-right" dir="rtl">
                        <h3 class="font-semibold text-blue-400 mb-2 font-amiri">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</h3>
                        <p id="duaAr" class="text-gray-200 text-lg font-amiri"></p>
                    </div>

                    <div class="p-4 bg-ramadan-green/20 rounded-lg border border-ramadan-green/30">
                        <h3 class="font-semibold text-ramadan-green mb-2">ğŸ“– How to use</h3>
                        <p id="duaInstructions" class="text-gray-300"></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- AI ANALYZER PAGE -->
    <div id="analyzer" class="page">
        <main class="container mx-auto py-12 px-4">
            <h1 class="text-4xl font-bold text-ramadan-gold mb-4 text-center">ğŸ¤– Ask AI - Islamic Guidance</h1>
            <p class="text-center text-gray-400 mb-8 text-lg">Get Quran Ayahs & Hadiths with AI explanations</p>

            <div class="max-w-3xl mx-auto">
                <div class="bg-gray-800/50 rounded-xl border border-gray-700 p-8 mb-8">
                    <textarea id="promptInput" placeholder="Ask any Islamic question... (e.g., 'How do I deal with anxiety?' or 'What is the importance of patience?')" class="w-full px-4 py-4 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg focus:border-ramadan-gold focus:ring-2 focus:ring-ramadan-gold/30 outline-none resize-none" rows="4"></textarea>
                    <button onclick="analyzePrompt()" id="analyzeBtn" class="w-full mt-4 px-6 py-4 bg-gradient-to-r from-ramadan-gold to-yellow-500 text-ramadan-night font-bold text-lg rounded-lg hover:from-yellow-500 hover:to-ramadan-gold transition-all duration-300">ğŸ¤– Analyze with AI</button>
                </div>

                <div id="analyzerLoading" class="text-center mb-8 hidden">
                    <div class="inline-block">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-ramadan-gold"></div>
                        <p class="text-ramadan-gold font-semibold mt-2">Analyzing your question...</p>
                    </div>
                </div>

                <div id="analyzerResults" class="hidden space-y-6">
                    <div class="bg-ramadan-purple/30 rounded-xl border border-ramadan-purple/50 p-6">
                        <h2 class="text-2xl font-bold text-ramadan-gold mb-4">ğŸ¤– AI Analysis</h2>
                        <p id="aiExplanation" class="text-gray-200 leading-relaxed whitespace-pre-line"></p>
                    </div>

                    <div id="ayahSection" class="bg-ramadan-green/20 rounded-xl border border-ramadan-green/30 p-6">
                        <h2 class="text-2xl font-bold text-ramadan-green mb-4">ğŸ“– Quranic Verse</h2>
                        <div class="bg-gray-800/50 rounded-lg p-4 mb-4">
                            <p id="ayahArabic" class="text-xl text-gray-200 text-right mb-2 font-amiri" dir="rtl"></p>
                            <p id="ayahReference" class="text-sm text-ramadan-gold font-semibold"></p>
                        </div>
                        <p id="ayahTranslation" class="text-gray-300 mb-4"></p>
                        <p id="ayahExplanation" class="text-gray-400 text-sm"></p>
                    </div>

                    <div id="hadithSection" class="bg-orange-900/30 rounded-xl border border-orange-700/50 p-6">
                        <h2 class="text-2xl font-bold text-orange-400 mb-4">ğŸ“š Related Hadith</h2>
                        <div class="bg-gray-800/50 rounded-lg p-4 mb-4">
                            <p id="hadithText" class="text-gray-200"></p>
                            <p id="hadithSource" class="text-sm text-orange-400 font-semibold mt-2"></p>
                        </div>
                        <p id="hadithExplanation" class="text-gray-400"></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ISLAMIC VIDEOS PAGE -->
    <div id="videos" class="page">
        <main class="container mx-auto py-12 px-4">
            <h1 class="text-4xl font-bold text-ramadan-gold mb-2 text-center">ğŸ“º Islamic Videos</h1>
            <p class="text-center text-gray-400 mb-8 text-lg">Search for Islamic educational videos on YouTube</p>

            <div class="max-w-3xl mx-auto">
                <div class="bg-gray-800/50 rounded-xl border border-gray-700 p-8 mb-8">
                    <label class="block text-sm font-semibold text-gray-300 mb-2">What would you like to learn about?</label>
                    <textarea id="videoSearchPrompt" placeholder="e.g., 'How to improve my prayer concentration', 'Understanding Surah Al-Fatiha', 'Tips for fasting during Ramadan'" class="w-full px-4 py-4 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg focus:border-ramadan-gold focus:ring-2 focus:ring-ramadan-gold/30 outline-none resize-none" rows="3"></textarea>
                    <button onclick="searchIslamicVideos()" id="searchVideoBtn" class="w-full mt-4 px-6 py-4 bg-gradient-to-r from-red-600 to-red-500 text-white font-bold text-lg rounded-lg hover:from-red-500 hover:to-red-600 transition-all duration-300">ğŸ” Search Islamic Videos</button>
                </div>

                <div id="videoLoading" class="text-center mb-8 hidden">
                    <div class="inline-block">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500"></div>
                        <p class="text-red-400 font-semibold mt-2">Searching for videos...</p>
                    </div>
                </div>

                <div id="videoResults" class="hidden">
                    <div class="bg-ramadan-purple/30 rounded-lg border border-ramadan-purple/50 p-4 mb-6">
                        <p class="text-gray-300"><strong class="text-ramadan-gold">Search:</strong> <span id="videoSearchQuery"></span></p>
                    </div>
                    
                    <div id="videosGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    
                    <div id="noVideosMessage" class="hidden bg-yellow-900/30 border border-yellow-700/50 rounded-lg p-6 text-center">
                        <p class="text-yellow-400 font-semibold">No videos found. Try a different search term.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- CHAT WITH IMAM PAGE -->
    <div id="chat" class="page">
        <main class="container mx-auto py-12 px-4">
            <h1 class="text-4xl font-bold text-ramadan-gold mb-2 text-center">ğŸ’¬ Chat with Imam</h1>
            <p class="text-center text-gray-400 mb-8 text-lg">Have a private conversation with a real Imam about your questions</p>

            <!-- USER VIEW: Select Imam and Chat -->
            <div id="userChatView" class="max-w-4xl mx-auto">
                <!-- Conversations List -->
                <div id="conversationsList" class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-white">Your Conversations</h2>
                        <button id="switchToImamBtn" onclick="switchToImamView()" class="hidden px-4 py-2 bg-purple-600/30 text-purple-400 rounded hover:bg-purple-600/50 transition-colors text-sm border border-purple-500/30">ğŸ•Œ Imam Dashboard</button>
                    </div>
                    <div id="myConversations" class="space-y-3 mb-6">
                        <p class="text-gray-400 italic">Loading your conversations...</p>
                    </div>
                    <button onclick="showNewConversationForm()" id="newConvoBtn" class="px-6 py-3 bg-gradient-to-r from-ramadan-purple to-purple-600 text-white font-semibold rounded-lg hover:from-purple-600 hover:to-ramadan-purple transition-all duration-300">â• Start New Conversation</button>
                </div>

                <!-- New Conversation Form -->
                <div id="newConversationForm" class="hidden bg-gray-800/50 rounded-xl border border-gray-700 p-6 mb-8">
                    <h3 class="text-xl font-bold text-ramadan-gold mb-4">Start a New Conversation</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Select an Imam</label>
                        <select id="imamSelect" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-white rounded-lg focus:border-ramadan-gold focus:ring-2 focus:ring-ramadan-gold/30 outline-none">
                            <option value="">-- Select an Imam --</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Topic / Subject</label>
                        <input type="text" id="conversationTopic" placeholder="e.g., Marriage advice, Prayer questions, Fasting guidance..." class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg focus:border-ramadan-gold focus:ring-2 focus:ring-ramadan-gold/30 outline-none">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Your Initial Message</label>
                        <textarea id="initialMessage" placeholder="Write your question or concern here..." rows="4" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg focus:border-ramadan-gold focus:ring-2 focus:ring-ramadan-gold/30 outline-none resize-none"></textarea>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="startConversation()" class="flex-1 px-6 py-3 bg-gradient-to-r from-ramadan-gold to-yellow-500 text-ramadan-night font-semibold rounded-lg hover:from-yellow-500 hover:to-ramadan-gold transition-all duration-300">ğŸ“¨ Send to Imam</button>
                        <button onclick="hideNewConversationForm()" class="px-6 py-3 bg-gray-600 text-gray-200 font-semibold rounded-lg hover:bg-gray-500 transition-colors">Cancel</button>
                    </div>
                </div>

                <!-- Active Chat Interface -->
                <div id="chatInterface" class="hidden bg-gray-800/50 rounded-xl border border-gray-700 overflow-hidden">
                    <div class="bg-gradient-to-r from-ramadan-purple to-purple-700 text-white p-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 id="chatImamName" class="font-bold text-lg">Imam Name</h3>
                                <p id="chatTopic" class="text-purple-200 text-sm">Topic</p>
                            </div>
                            <button onclick="closeChat()" class="px-4 py-2 bg-white/20 rounded hover:bg-white/30 transition-colors">â† Back</button>
                        </div>
                    </div>
                    
                    <div id="messagesContainer" class="h-96 overflow-y-auto p-4 bg-gray-900/50">
                        <!-- Messages will be loaded here -->
                    </div>
                    
                    <div class="p-4 bg-gray-800 border-t border-gray-700">
                        <div class="flex gap-3">
                            <textarea id="messageInput" placeholder="Type your message..." rows="2" class="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg focus:border-ramadan-gold focus:ring-2 focus:ring-ramadan-gold/30 outline-none resize-none"></textarea>
                            <button onclick="sendMessage()" class="px-6 py-3 bg-gradient-to-r from-ramadan-gold to-yellow-500 text-ramadan-night font-semibold rounded-lg hover:from-yellow-500 hover:to-ramadan-gold transition-all duration-300">Send ğŸ“¤</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- IMAM VIEW: Dashboard -->
            <div id="imamChatView" class="hidden max-w-4xl mx-auto">
                <div class="bg-gradient-to-r from-ramadan-purple to-purple-700 text-white rounded-xl border border-ramadan-purple/50 p-6 mb-8">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">ğŸ•Œ Imam Dashboard</h2>
                            <p class="text-purple-200">View and respond to user conversations</p>
                        </div>
                        <button onclick="switchToUserView()" class="px-4 py-2 bg-white/20 rounded hover:bg-white/30 transition-colors text-sm">ğŸ‘¤ Switch to User View</button>
                    </div>
                </div>

                <div id="imamConversationsList" class="space-y-4">
                    <p class="text-gray-400 italic">Loading conversations...</p>
                </div>

                <!-- Imam Chat Interface -->
                <div id="imamChatInterface" class="hidden bg-gray-800/50 rounded-xl border border-gray-700 overflow-hidden mt-8">
                    <div class="bg-gradient-to-r from-ramadan-purple to-purple-700 text-white p-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 id="imamChatUserEmail" class="font-bold text-lg">User Email</h3>
                                <p id="imamChatTopic" class="text-purple-200 text-sm">Topic</p>
                            </div>
                            <button onclick="closeImamChat()" class="px-4 py-2 bg-white/20 rounded hover:bg-white/30 transition-colors">â† Back</button>
                        </div>
                    </div>
                    
                    <div id="imamMessagesContainer" class="h-96 overflow-y-auto p-4 bg-gray-900/50">
                        <!-- Messages will be loaded here -->
                    </div>
                    
                    <div class="p-4 bg-gray-800 border-t border-gray-700">
                        <div class="flex gap-3">
                            <textarea id="imamMessageInput" placeholder="Type your response..." rows="2" class="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg focus:border-ramadan-gold focus:ring-2 focus:ring-ramadan-gold/30 outline-none resize-none"></textarea>
                            <button onclick="sendImamMessage()" class="px-6 py-3 bg-gradient-to-r from-ramadan-purple to-purple-600 text-white font-semibold rounded-lg hover:from-purple-600 hover:to-ramadan-purple transition-all duration-300">Reply ğŸ“¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="bg-ramadan-dark text-gray-400 text-center py-6 border-t border-ramadan-gold/20">
        <p class="text-ramadan-gold">â˜ªï¸ Ramadan Mubarak</p>
        <p class="mt-2">Â© 2026 Ramadan Helper. May Allah accept from us. ğŸŒ™</p>
    </footer>

    <script>
        // ============= CONFIGURATION =============
        const API_BASE_URL = "http://localhost:8000/api";
        let backendOnline = false;
        
        // JWT Token Storage
        let authToken = localStorage.getItem('authToken') || null;
        let refreshToken = localStorage.getItem('refreshToken') || null;
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let currentImam = JSON.parse(localStorage.getItem('currentImam')) || null;
        let userEmail = localStorage.getItem('userEmail') || '';

        // Get auth headers for API calls
        function getAuthHeaders() {
            const headers = { 'Content-Type': 'application/json' };
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            return headers;
        }

        // ============= INITIALIZATION =============
        document.addEventListener('DOMContentLoaded', async function() {
            initLogin();
            checkBackendStatus();
            loadCities();
            setupRealTimeValidation();
            checkUrlForVerification();
        });

        // ============= BACKEND STATUS =============
        async function checkBackendStatus() {
            const indicator = document.getElementById('statusIndicator');

            // Manual timeout to avoid AbortSignal API compatibility issues
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);

            try {
                const response = await fetch('http://localhost:8000/', {
                    method: 'GET',
                    cache: 'no-cache',
                    headers: { 'Cache-Control': 'no-cache' },
                    signal: controller.signal
                });

                if (response.ok) {
                    backendOnline = true;
                    indicator.className = 'inline-flex items-center gap-2 px-4 py-2 rounded-full bg-ramadan-green/20 text-green-400 border border-green-500/30';
                    indicator.innerHTML = '<span class="text-green-400">â—</span> All services online';
                } else {
                    backendOnline = false;
                    indicator.className = 'inline-flex items-center gap-2 px-4 py-2 rounded-full bg-ramadan-gold/20 text-ramadan-gold border border-ramadan-gold/30';
                    indicator.innerHTML = '<span class="text-ramadan-gold">â—</span> Demo Mode - <a href="https://github.com/cheehub213/ramadan-webservice-project-" target="_blank" class="underline">Run backend for full features</a>';
                }
            } catch (error) {
                console.warn('Backend status check failed', error);
                backendOnline = false;
                indicator.className = 'inline-flex items-center gap-2 px-4 py-2 rounded-full bg-ramadan-gold/20 text-ramadan-gold border border-ramadan-gold/30';
                indicator.innerHTML = '<span class="text-ramadan-gold">â—</span> Demo Mode - <a href="https://github.com/cheehub213/ramadan-webservice-project-" target="_blank" class="underline">Run backend for full features</a>';
            } finally {
                clearTimeout(timeoutId);
            }
        }

        // ============= EMAIL VALIDATION =============
        async function validateEmailRealTime(email) {
            const statusDiv = document.getElementById('emailValidationStatus');
            
            // Basic format check
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                statusDiv.style.display = 'block';
                statusDiv.style.background = 'rgba(220, 38, 38, 0.2)';
                statusDiv.style.color = '#f87171';
                statusDiv.textContent = 'âŒ Invalid email format';
                return false;
            }

            // Check domain validity using DNS lookup API
            statusDiv.style.display = 'block';
            statusDiv.style.background = 'rgba(212, 175, 55, 0.2)';
            statusDiv.style.color = '#D4AF37';
            statusDiv.textContent = 'ğŸ” Validating email...';

            try {
                // Validate using abstract email validation API (free tier)
                const domain = email.split('@')[1];
                const dnsResponse = await fetch(`https://dns.google/resolve?name=${domain}&type=MX`);
                const dnsData = await dnsResponse.json();
                
                if (dnsData.Answer && dnsData.Answer.length > 0) {
                    statusDiv.style.background = 'rgba(34, 197, 94, 0.2)';
                    statusDiv.style.color = '#22c55e';
                    statusDiv.textContent = `âœ… Valid email domain (${domain})`;
                    return true;
                } else {
                    statusDiv.style.background = 'rgba(220, 38, 38, 0.2)';
                    statusDiv.style.color = '#f87171';
                    statusDiv.textContent = 'âŒ Invalid email domain - cannot receive emails';
                    return false;
                }
            } catch (error) {
                // If DNS check fails, do basic validation
                statusDiv.style.background = 'rgba(212, 175, 55, 0.2)';
                statusDiv.style.color = '#D4AF37';
                statusDiv.textContent = 'âš ï¸ Could not verify domain, but format is valid';
                return true; // Allow but warn
            }
        }

        // ============= PASSWORD VALIDATION =============
        function validatePassword(password) {
            const hasMinLength = password.length >= 8;
            const hasLetter = /[a-zA-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            
            return {
                isValid: hasMinLength && hasLetter && hasNumber,
                hasMinLength,
                hasLetter,
                hasNumber
            };
        }

        function updatePasswordStrength(inputId, strengthId) {
            const password = document.getElementById(inputId).value;
            const strengthDiv = document.getElementById(strengthId);
            const validation = validatePassword(password);
            
            let html = '';
            html += `<span style="color: ${validation.hasMinLength ? '#22c55e' : '#f87171'}">â— 8+ characters</span> `;
            html += `<span style="color: ${validation.hasLetter ? '#22c55e' : '#f87171'}">â— Letter</span> `;
            html += `<span style="color: ${validation.hasNumber ? '#22c55e' : '#f87171'}">â— Number</span>`;
            
            strengthDiv.innerHTML = html;
            return validation.isValid;
        }

        function setupRealTimeValidation() {
            // Email validation on signup
            const signupEmail = document.getElementById('signupEmailInput');
            if (signupEmail) {
                let debounceTimer;
                signupEmail.addEventListener('input', () => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        if (signupEmail.value.length > 5) {
                            validateEmailRealTime(signupEmail.value);
                        }
                    }, 500);
                });
            }
            
            // Password strength indicator
            const signupPassword = document.getElementById('signupPasswordInput');
            if (signupPassword) {
                signupPassword.addEventListener('input', () => {
                    updatePasswordStrength('signupPasswordInput', 'passwordStrength');
                });
            }
        }

        // ============= LOGIN SYSTEM (JWT) =============
        function initLogin() {
            const loginModal = document.getElementById('loginModal');
            const loginTypeSelection = document.getElementById('loginTypeSelection');
            const userLoginForm = document.getElementById('userLoginForm');
            const imamLoginForm = document.getElementById('imamLoginForm');
            const userSignupForm = document.getElementById('userSignupForm');
            const imamSignupForm = document.getElementById('imamSignupForm');
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');

            // Check if already logged in with valid token
            if (authToken && (currentUser || currentImam)) {
                verifyToken().then(valid => {
                    if (valid) {
                        loginModal.style.display = 'none';
                        document.getElementById('userProfileHeader').classList.remove('hidden');
                        if (currentUser) {
                            document.getElementById('userTypeDisplay').textContent = 'ğŸ‘¤ User';
                            document.getElementById('userNameDisplay').textContent = currentUser.name || currentUser.email;
                            userEmail = currentUser.email;
                        }
                        if (currentImam) {
                            document.getElementById('userTypeDisplay').textContent = 'ğŸ•Œ Imam';
                            document.getElementById('userNameDisplay').textContent = currentImam.name;
                        }
                    } else {
                        // Token invalid, try refresh
                        refreshAuthToken();
                    }
                });
                return;
            }

            // Button handlers for main selection
            document.getElementById('btnUserLogin').onclick = () => {
                hideAllForms();
                userLoginForm.style.display = 'block';
            };

            document.getElementById('btnUserSignup').onclick = () => {
                hideAllForms();
                userSignupForm.style.display = 'block';
            };

            document.getElementById('btnImamLogin').onclick = () => {
                hideAllForms();
                imamLoginForm.style.display = 'block';
            };

            document.getElementById('btnBackFromUser').onclick = () => {
                hideAllForms();
                loginTypeSelection.style.display = 'block';
            };

            document.getElementById('btnBackFromSignup').onclick = () => {
                hideAllForms();
                loginTypeSelection.style.display = 'block';
            };

            document.getElementById('btnBackFromImam').onclick = () => {
                hideAllForms();
                loginTypeSelection.style.display = 'block';
            };

            // Submit handlers
            document.getElementById('btnSubmitUserLogin').onclick = handleUserLogin;
            document.getElementById('btnSubmitSignup').onclick = handleUserSignup;
            document.getElementById('btnSubmitImamLogin').onclick = handleImamLogin;
            document.getElementById('btnSubmitImamSignup').onclick = handleImamSignup;
            document.getElementById('btnSubmitReset').onclick = handlePasswordReset;
        }

        function hideAllForms() {
            document.getElementById('loginTypeSelection').style.display = 'none';
            document.getElementById('userLoginForm').style.display = 'none';
            document.getElementById('userSignupForm').style.display = 'none';
            document.getElementById('imamLoginForm').style.display = 'none';
            document.getElementById('imamSignupForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('verificationPendingScreen').style.display = 'none';
        }

        function showForgotPassword() {
            hideAllForms();
            document.getElementById('forgotPasswordForm').style.display = 'block';
        }

        function showUserLoginFromSignup() {
            hideAllForms();
            document.getElementById('userLoginForm').style.display = 'block';
        }

        function showUserLoginFromReset() {
            hideAllForms();
            document.getElementById('userLoginForm').style.display = 'block';
        }

        function showImamSignup() {
            hideAllForms();
            document.getElementById('imamSignupForm').style.display = 'block';
        }

        function showImamLoginFromSignup() {
            hideAllForms();
            document.getElementById('imamLoginForm').style.display = 'block';
        }

        function backToLoginSelection() {
            hideAllForms();
            document.getElementById('loginTypeSelection').style.display = 'block';
        }

        function showVerificationPending(email, debugToken = null) {
            hideAllForms();
            document.getElementById('verificationPendingScreen').style.display = 'block';
            document.getElementById('pendingEmailDisplay').textContent = email;
            localStorage.setItem('pendingVerificationEmail', email);
            
            // Show demo token if SMTP not configured
            if (debugToken) {
                document.getElementById('demoTokenDisplay').style.display = 'block';
                document.getElementById('demoToken').textContent = debugToken;
            } else {
                document.getElementById('demoTokenDisplay').style.display = 'none';
            }
        }

        // ============= USER LOGIN HANDLER =============
        async function handleUserLogin() {
            const email = document.getElementById('userEmailInput').value.trim();
            const password = document.getElementById('userPasswordInput').value.trim();
            const errorEl = document.getElementById('userEmailError');
            const statusEl = document.getElementById('userLoginStatus');

            if (!email || !email.includes('@') || !email.includes('.')) {
                errorEl.textContent = 'Please enter a valid email address';
                errorEl.style.display = 'block';
                return;
            }

            if (!password) {
                errorEl.textContent = 'Please enter your password';
                errorEl.style.display = 'block';
                return;
            }

            errorEl.style.display = 'none';
            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(212, 175, 55, 0.2)';
            statusEl.style.color = '#D4AF37';
            statusEl.textContent = 'â³ Logging in...';

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.access_token;
                    refreshToken = data.refresh_token;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    
                    currentUser = { 
                        type: 'user', 
                        email: data.user_email, 
                        name: data.user_name, 
                        loginTime: new Date().toISOString() 
                    };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    localStorage.setItem('userEmail', data.user_email);
                    userEmail = data.user_email;

                    statusEl.style.background = 'rgba(34, 197, 94, 0.2)';
                    statusEl.style.color = '#22c55e';
                    statusEl.textContent = 'âœ… Login successful!';
                    setTimeout(completeUserLogin, 500);
                } else if (response.status === 403 && data.detail === 'EMAIL_NOT_VERIFIED') {
                    // Email not verified - show verification screen
                    statusEl.style.background = 'rgba(234, 179, 8, 0.2)';
                    statusEl.style.color = '#eab308';
                    statusEl.textContent = 'âš ï¸ Please verify your email first';
                    setTimeout(() => showVerificationPending(email), 1000);
                } else {
                    statusEl.style.background = 'rgba(220, 38, 38, 0.2)';
                    statusEl.style.color = '#f87171';
                    statusEl.textContent = `âŒ ${data.detail || 'Login failed'}`;
                }
            } catch (error) {
                console.warn('Login error:', error.message);
                // Only demo mode for actual network failures
                if (error instanceof TypeError || error.message === 'Failed to fetch') {
                    const name = email.split('@')[0];
                    currentUser = { type: 'user', email, name, loginTime: new Date().toISOString() };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    localStorage.setItem('userEmail', email);
                    userEmail = email;

                    statusEl.style.background = 'rgba(212, 175, 55, 0.2)';
                    statusEl.style.color = '#D4AF37';
                    statusEl.textContent = 'âœ… Login successful (Demo Mode - backend offline)!';
                    setTimeout(completeUserLogin, 500);
                } else {
                    statusEl.style.background = 'rgba(220, 38, 38, 0.2)';
                    statusEl.style.color = '#f87171';
                    statusEl.textContent = `âŒ ${error.message}`;
                }
            }
        }

        function completeUserLogin() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('userProfileHeader').classList.remove('hidden');
            document.getElementById('userTypeDisplay').textContent = 'ğŸ‘¤ User';
            document.getElementById('userNameDisplay').textContent = currentUser.name || currentUser.email;
        }

        // ============= USER SIGNUP HANDLER =============
        async function handleUserSignup() {
            const name = document.getElementById('signupNameInput').value.trim();
            const email = document.getElementById('signupEmailInput').value.trim();
            const password = document.getElementById('signupPasswordInput').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const statusEl = document.getElementById('signupStatus');

            // Validation
            if (!name || name.length < 2) {
                showStatus(statusEl, 'âŒ Please enter your full name', 'error');
                return;
            }

            if (!email || !email.includes('@') || !email.includes('.')) {
                showStatus(statusEl, 'âŒ Please enter a valid email address', 'error');
                return;
            }

            const passwordValidation = validatePassword(password);
            if (!passwordValidation.isValid) {
                showStatus(statusEl, 'âŒ Password must be at least 8 characters with a letter and number', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showStatus(statusEl, 'âŒ Passwords do not match', 'error');
                return;
            }

            // Validate email domain
            const emailValid = await validateEmailRealTime(email);
            if (!emailValid && document.getElementById('emailValidationStatus').textContent.includes('Invalid')) {
                showStatus(statusEl, 'âŒ Please use a valid email address', 'error');
                return;
            }

            showStatus(statusEl, 'â³ Creating your account...', 'loading');

            try {
                const response = await fetch(`${API_BASE_URL}/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // Account created - now need to verify email
                    if (data.requires_verification) {
                        showStatus(statusEl, 'âœ… Account created! Please check your email to verify.', 'success');
                        setTimeout(() => showVerificationPending(email, data.debug_token), 1500);
                    } else {
                        // If no verification required (shouldn't happen normally)
                        showStatus(statusEl, 'âœ… Account created successfully!', 'success');
                        setTimeout(completeUserLogin, 1000);
                    }
                } else {
                    showStatus(statusEl, `âŒ ${data.detail || 'Signup failed'}`, 'error');
                }
            } catch (error) {
                console.warn('Signup error:', error.message);
                // Only demo mode for actual network failures
                if (error instanceof TypeError || error.message === 'Failed to fetch') {
                    showStatus(statusEl, 'âœ… Account created (Demo Mode - backend offline)! Verification required.', 'success');
                    setTimeout(() => showVerificationPending(email, 'demo-token-' + Date.now()), 1500);
                } else {
                    showStatus(statusEl, `âŒ ${error.message}`, 'error');
                }
            }
        }

        // ============= EMAIL VERIFICATION HANDLERS =============
        async function resendVerificationEmail() {
            const email = localStorage.getItem('pendingVerificationEmail') || document.getElementById('pendingEmailDisplay').textContent;
            const statusEl = document.getElementById('verifyStatus');
            const btn = document.getElementById('resendVerifyBtn');
            
            if (!email) {
                showStatus(statusEl, 'âŒ No email found. Please try signing up again.', 'error');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'â³ Sending...';
            showStatus(statusEl, 'â³ Sending verification email...', 'loading');
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/resend-verification`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus(statusEl, 'âœ… Verification email sent! Check your inbox.', 'success');
                    
                    // Show demo token if provided
                    if (data.debug_token) {
                        document.getElementById('demoTokenDisplay').style.display = 'block';
                        document.getElementById('demoToken').textContent = data.debug_token;
                    }
                } else {
                    showStatus(statusEl, `âŒ ${data.detail || 'Failed to resend email'}`, 'error');
                }
            } catch (error) {
                showStatus(statusEl, 'âš ï¸ Could not resend email. Server may be offline.', 'warning');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“§ Resend Verification Email';
            }
        }
        
        async function verifyEmailManually() {
            const token = document.getElementById('manualVerifyToken').value.trim();
            const statusEl = document.getElementById('verifyStatus');
            
            if (!token) {
                showStatus(statusEl, 'âŒ Please enter the verification token', 'error');
                return;
            }
            
            showStatus(statusEl, 'â³ Verifying your email...', 'loading');
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/verify-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });
                
                const data = await response.json();
                
                if (response.ok && data.verified) {
                    showStatus(statusEl, 'âœ… Email verified successfully! Logging you in...', 'success');
                    
                    // Store tokens and login
                    authToken = data.access_token;
                    refreshToken = data.refresh_token;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    
                    currentUser = { 
                        type: 'user', 
                        email: data.user_email, 
                        name: data.user_name, 
                        loginTime: new Date().toISOString() 
                    };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    localStorage.setItem('userEmail', data.user_email);
                    localStorage.removeItem('pendingVerificationEmail');
                    userEmail = data.user_email;
                    
                    setTimeout(completeUserLogin, 1000);
                } else {
                    showStatus(statusEl, `âŒ ${data.detail || 'Verification failed'}`, 'error');
                }
            } catch (error) {
                showStatus(statusEl, 'âš ï¸ Could not verify. Server may be offline.', 'warning');
            }
        }
        
        // Check URL for verification token on page load
        function checkUrlForVerification() {
            const urlParams = new URLSearchParams(window.location.search);
            const verifyToken = urlParams.get('verify');
            
            if (verifyToken) {
                // Auto-fill and verify
                document.getElementById('manualVerifyToken').value = verifyToken;
                showVerificationPending(localStorage.getItem('pendingVerificationEmail') || 'your email');
                setTimeout(() => verifyEmailManually(), 500);
                
                // Clear URL params
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // ============= IMAM LOGIN HANDLER =============
        async function handleImamLogin() {
            const name = document.getElementById('imamNameInput').value.trim();
            const email = document.getElementById('imamEmailInput').value.trim();
            const password = document.getElementById('imamPasswordInput').value.trim();
            const statusEl = document.getElementById('imamLoginStatus');

            if (!name || !email || !password) {
                showStatus(statusEl, 'âŒ Please fill all fields', 'error');
                return;
            }

            showStatus(statusEl, 'â³ Logging in...', 'loading');

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    refreshToken = data.refresh_token;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                }
            } catch (e) {}

            currentImam = { type: 'imam', name, email, loginTime: new Date().toISOString() };
            localStorage.setItem('currentImam', JSON.stringify(currentImam));

            showStatus(statusEl, 'âœ… Login successful!', 'success');
            setTimeout(completeImamLogin, 500);
        }

        function completeImamLogin() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('userProfileHeader').classList.remove('hidden');
            document.getElementById('userTypeDisplay').textContent = 'ğŸ•Œ Imam';
            document.getElementById('userNameDisplay').textContent = currentImam.name;
        }

        // ============= IMAM SIGNUP HANDLER =============
        async function handleImamSignup() {
            const name = document.getElementById('imamSignupName').value.trim();
            const email = document.getElementById('imamSignupEmail').value.trim();
            const expertise = document.getElementById('imamSignupExpertise').value.trim();
            const password = document.getElementById('imamSignupPassword').value;
            const confirmPassword = document.getElementById('imamSignupConfirm').value;
            const statusEl = document.getElementById('imamSignupStatus');

            if (!name || !email || !expertise || !password) {
                showStatus(statusEl, 'âŒ Please fill all fields', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showStatus(statusEl, 'âŒ Passwords do not match', 'error');
                return;
            }

            const passwordValidation = validatePassword(password);
            if (!passwordValidation.isValid) {
                showStatus(statusEl, 'âŒ Password must be at least 8 characters with a letter and number', 'error');
                return;
            }

            showStatus(statusEl, 'â³ Registering as Imam...', 'loading');

            try {
                const response = await fetch(`${API_BASE_URL}/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password, is_imam: true, expertise })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.access_token;
                    refreshToken = data.refresh_token;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    
                    currentImam = { type: 'imam', name, email, expertise, loginTime: new Date().toISOString() };
                    localStorage.setItem('currentImam', JSON.stringify(currentImam));

                    showStatus(statusEl, 'âœ… Registration successful!', 'success');
                    setTimeout(completeImamLogin, 1000);
                } else {
                    showStatus(statusEl, `âŒ ${data.detail || 'Registration failed'}`, 'error');
                }
            } catch (error) {
                console.warn('Imam signup error:', error.message);
                // Only demo mode for actual network failures
                if (error instanceof TypeError || error.message === 'Failed to fetch') {
                    currentImam = { type: 'imam', name, email, expertise, loginTime: new Date().toISOString() };
                    localStorage.setItem('currentImam', JSON.stringify(currentImam));

                    showStatus(statusEl, 'âœ… Registration successful (Demo Mode - backend offline)!', 'success');
                    setTimeout(completeImamLogin, 1000);
                } else {
                    showStatus(statusEl, `âŒ ${error.message}`, 'error');
                }
            }
        }

        // ============= PASSWORD RESET HANDLER =============
        async function handlePasswordReset() {
            const email = document.getElementById('resetEmailInput').value.trim();
            const statusEl = document.getElementById('resetStatus');

            if (!email || !email.includes('@')) {
                showStatus(statusEl, 'âŒ Please enter a valid email address', 'error');
                return;
            }

            showStatus(statusEl, 'â³ Sending reset link...', 'loading');

            try {
                const response = await fetch(`${API_BASE_URL}/auth/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(statusEl, 'âœ… If an account exists with this email, a reset link has been sent.', 'success');
                } else {
                    showStatus(statusEl, 'âœ… If an account exists with this email, a reset link has been sent.', 'success');
                }
            } catch (error) {
                showStatus(statusEl, 'âš ï¸ Password reset is not available in demo mode.', 'warning');
            }
        }

        // ============= TOKEN MANAGEMENT =============
        async function verifyToken() {
            if (!authToken) return false;
            try {
                const response = await fetch(`${API_BASE_URL}/auth/verify-token`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        async function refreshAuthToken() {
            if (!refreshToken) {
                logout();
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    refreshToken = data.refresh_token;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('refreshToken', refreshToken);
                    
                    // Complete login
                    document.getElementById('loginModal').style.display = 'none';
                    document.getElementById('userProfileHeader').classList.remove('hidden');
                } else {
                    logout();
                }
            } catch (error) {
                // Offline mode - keep existing session
            }
        }

        // ============= PROFILE MANAGEMENT =============
        function showProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.remove('hidden');
            
            // Populate current values
            if (currentUser) {
                document.getElementById('profileName').value = currentUser.name || '';
                document.getElementById('profileEmail').value = currentUser.email || '';
            } else if (currentImam) {
                document.getElementById('profileName').value = currentImam.name || '';
                document.getElementById('profileEmail').value = currentImam.email || '';
            }
        }

        function hideProfileModal() {
            document.getElementById('profileModal').classList.add('hidden');
            document.getElementById('profileStatus').classList.add('hidden');
        }

        async function updateProfile() {
            const name = document.getElementById('profileName').value.trim();
            const statusEl = document.getElementById('profileStatus');

            if (!name) {
                showStatus(statusEl, 'âŒ Name is required', 'error');
                return;
            }

            showStatus(statusEl, 'â³ Updating profile...', 'loading');

            try {
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ name })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (currentUser) {
                        currentUser.name = data.name;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        document.getElementById('userNameDisplay').textContent = data.name;
                    }
                    showStatus(statusEl, 'âœ… Profile updated successfully!', 'success');
                } else {
                    showStatus(statusEl, 'âŒ Failed to update profile', 'error');
                }
            } catch (error) {
                console.warn('Update profile error:', error.message);
                // Only demo mode for actual network failures
                if (error instanceof TypeError || error.message === 'Failed to fetch') {
                    if (currentUser) {
                        currentUser.name = name;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        document.getElementById('userNameDisplay').textContent = name;
                    }
                    showStatus(statusEl, 'âœ… Profile updated (Demo Mode - backend offline)!', 'success');
                } else {
                    showStatus(statusEl, `âŒ ${error.message}`, 'error');
                }
            }
        }

        async function changePassword() {
            const currentPwd = document.getElementById('currentPassword').value;
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmNewPassword').value;
            const statusEl = document.getElementById('profileStatus');

            if (!currentPwd || !newPwd || !confirmPwd) {
                showStatus(statusEl, 'âŒ Please fill all password fields', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                showStatus(statusEl, 'âŒ New passwords do not match', 'error');
                return;
            }

            const passwordValidation = validatePassword(newPwd);
            if (!passwordValidation.isValid) {
                showStatus(statusEl, 'âŒ Password must be at least 8 characters with a letter and number', 'error');
                return;
            }

            showStatus(statusEl, 'â³ Changing password...', 'loading');

            try {
                const response = await fetch(`${API_BASE_URL}/auth/change-password`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ 
                        current_password: currentPwd, 
                        new_password: newPwd 
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(statusEl, 'âœ… Password changed successfully!', 'success');
                    // Clear password fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmNewPassword').value = '';
                } else {
                    showStatus(statusEl, `âŒ ${data.detail || 'Failed to change password'}`, 'error');
                }
            } catch (error) {
                console.warn('Change password error:', error.message);
                if (error instanceof TypeError || error.message === 'Failed to fetch') {
                    showStatus(statusEl, 'âš ï¸ Password change not available - backend offline', 'warning');
                } else {
                    showStatus(statusEl, `âŒ ${error.message}`, 'error');
                }
            }
        }

        // ============= HELPER FUNCTIONS =============
        function showStatus(element, message, type) {
            element.style.display = 'block';
            element.textContent = message;
            
            switch (type) {
                case 'success':
                    element.style.background = 'rgba(34, 197, 94, 0.2)';
                    element.style.color = '#22c55e';
                    break;
                case 'error':
                    element.style.background = 'rgba(220, 38, 38, 0.2)';
                    element.style.color = '#f87171';
                    break;
                case 'loading':
                    element.style.background = 'rgba(212, 175, 55, 0.2)';
                    element.style.color = '#D4AF37';
                    break;
                case 'warning':
                    element.style.background = 'rgba(234, 179, 8, 0.2)';
                    element.style.color = '#eab308';
                    break;
            }
        }

        function logout() {
            // Call backend logout if online
            if (authToken) {
                fetch(`${API_BASE_URL}/auth/logout`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                }).catch(() => {});
            }
            
            localStorage.removeItem('authToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentImam');
            localStorage.removeItem('userEmail');
            authToken = null;
            refreshToken = null;
            currentUser = null;
            currentImam = null;
            location.reload();
        }

        // ============= PAGE NAVIGATION =============
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0, 0);
            
            // Initialize chat when showing chat page
            if (pageId === 'chat') {
                initChat();
            }
            // Load events when showing events page
            if (pageId === 'events') {
                loadEvents();
            }
        }

        // ============= DUA GENERATOR =============
        async function generateDua() {
            const category = document.getElementById('duaCategory').value;
            const context = document.getElementById('duaContext').value.trim();
            const btn = document.getElementById('generateDuaBtn');
            const output = document.getElementById('duaOutput');

            if (!context) {
                alert('Please describe your situation');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'â³ Generating...';
            output.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE_URL}/dua/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userEmail || 'guest@app.local', category, context })
                });

                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('duaEn').textContent = data.dua_text_en;
                    document.getElementById('duaAr').textContent = data.dua_text_ar;
                    document.getElementById('duaInstructions').textContent = data.how_to_use_en || 'Recite with sincerity and focus.';
                    output.classList.remove('hidden');
                } else {
                    // API returned an error - show it
                    document.getElementById('duaEn').textContent = `Error: ${data.detail || 'Failed to generate dua'}`;
                    document.getElementById('duaAr').textContent = '';
                    document.getElementById('duaInstructions').textContent = 'Please try again or check the backend logs.';
                    output.classList.remove('hidden');
                }
            } catch (error) {
                // Network error - only show demo when truly offline
                const isNetworkError = (error instanceof TypeError) || error.message.includes('Failed to fetch') || error.message.includes('NetworkError');
                if (isNetworkError) {
                    document.getElementById('duaEn').textContent = `O Allah, the Most Merciful, I come to You seeking help with ${category.toLowerCase()}. You know my situation regarding "${context}". Grant me patience, wisdom, and Your guidance. Make this easy for me and bless me with the best outcome. Ameen.`;
                    document.getElementById('duaAr').textContent = 'Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ ÙŠÙØ§ Ø±ÙØ­Ù’Ù…ÙÙ†Ù ÙŠÙØ§ Ø±ÙØ­ÙÙŠÙ…ÙØŒ Ø£ÙØ³Ù’Ø£ÙÙ„ÙÙƒÙ Ø§Ù„Ù’Ø¹ÙÙˆÙ’Ù†Ù ÙˆÙØ§Ù„ØªÙÙ‘ÙˆÙ’ÙÙÙŠÙ‚ÙØŒ ÙˆÙØ§Ø¬Ù’Ø¹ÙÙ„Ù’ Ø£ÙÙ…Ù’Ø±ÙÙŠ ÙŠÙØ³Ù’Ø±Ù‹Ø§ØŒ ÙˆÙØ§Ø±Ù’Ø²ÙÙ‚Ù’Ù†ÙÙŠ Ø§Ù„ØµÙÙ‘Ø¨Ù’Ø±Ù ÙˆÙØ§Ù„Ù’Ø­ÙÙƒÙ’Ù…ÙØ©Ù. Ø¢Ù…ÙÙŠÙ†';
                    document.getElementById('duaInstructions').textContent = 'ğŸ”¹ Demo Mode: Backend is offline. Run the backend locally for AI-generated personalized duas.';
                } else {
                    document.getElementById('duaEn').textContent = `Error: ${error.message}`;
                    document.getElementById('duaAr').textContent = '';
                    document.getElementById('duaInstructions').textContent = 'Please try again.';
                }
                output.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ“¿ Generate My Dua';
            }
        }

        // ============= AI ANALYZER =============
        async function analyzePrompt() {
            const prompt = document.getElementById('promptInput').value.trim();
            const btn = document.getElementById('analyzeBtn');
            const loading = document.getElementById('analyzerLoading');
            const results = document.getElementById('analyzerResults');

            if (!prompt) {
                alert('Please enter your question');
                return;
            }

            btn.disabled = true;
            loading.classList.remove('hidden');
            results.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE_URL}/analyzer/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Backend expects `question` field per AnalyzeRequest schema
                    body: JSON.stringify({ question: prompt, email: userEmail || 'guest@app.local' })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Get section elements
                    const ayahSection = document.getElementById('ayahSection');
                    const hadithSection = document.getElementById('hadithSection');
                    
                    // Show AI explanation always
                    document.getElementById('aiExplanation').textContent = data.ai_explanation;
                    
                    // Check if match was found
                    if (data.match_found && data.ayah && data.hadith) {
                        // Show Quran verse and Hadith sections
                        ayahSection.classList.remove('hidden');
                        hadithSection.classList.remove('hidden');
                        
                        document.getElementById('ayahArabic').textContent = data.ayah.arabic;
                        document.getElementById('ayahReference').textContent = 'ğŸ“ ' + data.ayah.reference;
                        document.getElementById('ayahTranslation').textContent = data.ayah.translation;
                        document.getElementById('ayahExplanation').textContent = data.ayah.explanation;
                        document.getElementById('hadithText').textContent = data.hadith.text;
                        document.getElementById('hadithSource').textContent = 'ğŸ“š ' + data.hadith.narrator;
                        document.getElementById('hadithExplanation').textContent = data.hadith.explanation;
                    } else {
                        // No match - hide Quran and Hadith sections
                        ayahSection.classList.add('hidden');
                        hadithSection.classList.add('hidden');
                    }
                    
                    results.classList.remove('hidden');
                } else {
                    const errorText = await response.text();
                    throw new Error(`API error: ${response.status} ${errorText}`);
                }
            } catch (error) {
                // Prefer showing the actual error when the backend responds
                const isNetworkError = (error instanceof TypeError) || (error.message || '').toLowerCase().includes('network');
                if (!isNetworkError) {
                    document.getElementById('aiExplanation').textContent = `âŒ Analyzer error: ${error.message}`;
                    document.getElementById('ayahSection').classList.add('hidden');
                    document.getElementById('hadithSection').classList.add('hidden');
                } else {
                    // Show demo response when backend is offline
                    document.getElementById('aiExplanation').textContent = `ğŸ”¹ Demo Mode: Your question "${prompt}" would be analyzed by our AI to find the most relevant Quran verses and Hadiths. Run the backend locally for personalized AI-powered Islamic guidance.`;
                    document.getElementById('ayahArabic').textContent = 'ÙˆÙØ§ØµÙ’Ø¨ÙØ±Ù’ ÙˆÙÙ…ÙØ§ ØµÙØ¨Ù’Ø±ÙÙƒÙ Ø¥ÙÙ„ÙÙ‘Ø§ Ø¨ÙØ§Ù„Ù„ÙÙ‘Ù‡Ù';
                    document.getElementById('ayahReference').textContent = 'ğŸ“ Surah An-Nahl (16:127)';
                    document.getElementById('ayahTranslation').textContent = 'And be patient, and your patience is not but through Allah.';
                    document.getElementById('ayahExplanation').textContent = 'This verse reminds us that true patience comes from relying on Allah. Whatever challenge you face, turn to Him for strength.';
                    document.getElementById('hadithText').textContent = 'The Prophet (ï·º) said: "Whoever believes in Allah and the Last Day should speak good or remain silent."';
                    document.getElementById('hadithSource').textContent = 'ğŸ“š Sahih al-Bukhari & Muslim';
                    document.getElementById('hadithExplanation').textContent = 'This hadith teaches us the importance of mindful speech and self-control in our daily interactions.';
                }
                results.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                loading.classList.add('hidden');
            }
        }

        // ============= VIDEO SEARCH (Direct YouTube) =============
        async function searchIslamicVideos() {
            const prompt = document.getElementById('videoSearchPrompt').value.trim();
            const btn = document.getElementById('searchVideoBtn');
            const loading = document.getElementById('videoLoading');
            const results = document.getElementById('videoResults');
            const grid = document.getElementById('videosGrid');
            const noVideos = document.getElementById('noVideosMessage');

            if (!prompt) {
                alert('Please describe what you want to learn about');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'â³ Searching...';
            loading.classList.remove('hidden');
            results.classList.add('hidden');

            try {
                // First, try to get AI-generated search keywords from backend
                let searchQuery = prompt + ' Islamic lecture';
                
                try {
                    const aiResponse = await fetch(`${API_BASE_URL}/videos/search-by-prompt`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: userEmail || 'guest@app.local', prompt })
                    });
                    
                    if (aiResponse.ok) {
                        const aiData = await aiResponse.json();
                        searchQuery = aiData.search_query || searchQuery;
                    }
                } catch (e) {
                    console.log('Using default search query');
                }

                document.getElementById('videoSearchQuery').textContent = searchQuery;

                // Use YouTube search URL approach - display video cards that link to YouTube search
                const islamicChannels = [
                    { name: 'Mufti Menk', query: searchQuery + ' Mufti Menk' },
                    { name: 'Omar Suleiman', query: searchQuery + ' Omar Suleiman' },
                    { name: 'Nouman Ali Khan', query: searchQuery + ' Nouman Ali Khan' },
                    { name: 'Yasir Qadhi', query: searchQuery + ' Yasir Qadhi' },
                    { name: 'Islamic Guidance', query: searchQuery + ' Islamic lecture' },
                    { name: 'FreeQuranEducation', query: searchQuery + ' Quran' }
                ];

                grid.innerHTML = islamicChannels.map(channel => `
                    <div class="bg-white rounded-lg shadow hover:shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-br from-red-600 to-red-700 h-32 flex items-center justify-center">
                            <span class="text-6xl">ğŸ“º</span>
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-gray-900 mb-2">${channel.name}</h3>
                            <p class="text-sm text-gray-600 mb-4">Search for: "${prompt}"</p>
                            <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(channel.query)}" 
                               target="_blank" 
                               class="block w-full text-center px-4 py-3 bg-red-600 text-white font-semibold rounded hover:bg-red-700">
                                ğŸ” Search on YouTube
                            </a>
                        </div>
                    </div>
                `).join('');

                noVideos.classList.add('hidden');
                results.classList.remove('hidden');

            } catch (error) {
                console.error('Error:', error);
                alert('Error searching videos');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ” Search Islamic Videos';
                loading.classList.add('hidden');
            }
        }

        // ============= CHAT WITH IMAM =============
        let currentConversationId = null;
        let availableImams = [];

        // Initialize chat when page is shown
        function initChat() {
            console.log('initChat called');
            
            // ALWAYS show User view first - most users want to chat with imams
            // Imams can switch to their dashboard using the button
            document.getElementById('userChatView').classList.remove('hidden');
            document.getElementById('imamChatView').classList.add('hidden');
            
            // Show "Imam Dashboard" button if user is logged in as Imam
            const imamData = localStorage.getItem('currentImam');
            if (imamData) {
                document.getElementById('switchToImamBtn').classList.remove('hidden');
            } else {
                document.getElementById('switchToImamBtn').classList.add('hidden');
            }
            
            loadImams();
            loadUserConversations();
        }

        // Switch to user view (from imam dashboard)
        function switchToUserView() {
            // Don't remove imam data, just switch view
            document.getElementById('userChatView').classList.remove('hidden');
            document.getElementById('imamChatView').classList.add('hidden');
            document.getElementById('switchToImamBtn').classList.remove('hidden');
            loadImams();
            loadUserConversations();
        }

        // Switch to imam view (if logged in as imam)
        function switchToImamView() {
            // Try to restore currentImam from localStorage
            if (!currentImam) {
                const imamData = localStorage.getItem('currentImam');
                if (imamData) {
                    currentImam = JSON.parse(imamData);
                }
            }
            
            if (currentImam) {
                document.getElementById('userChatView').classList.add('hidden');
                document.getElementById('imamChatView').classList.remove('hidden');
                loadImamConversations();
            } else {
                alert('You need to be logged in as an Imam to access the Imam Dashboard');
            }
        }

        // Load available imams
        async function loadImams() {
            try {
                const response = await fetch(`${API_BASE_URL}/chat/imams`);
                if (response.ok) {
                    availableImams = await response.json();
                    const select = document.getElementById('imamSelect');
                    select.innerHTML = '<option value="">-- Select an Imam --</option>' + 
                        availableImams.map(imam => `
                            <option value="${imam.id}">${imam.name} - ${imam.expertise}</option>
                        `).join('');
                } else {
                    console.warn('Failed to load imams:', response.status);
                }
            } catch (error) {
                console.warn('loadImams error:', error);
                // Only show fallback if truly network error
                if (error.message && error.message.includes('Failed to fetch')) {
                    availableImams = [
                        { id: 1, name: 'Imam Ahmad', expertise: 'Quran & Islamic Law' },
                        { id: 2, name: 'Imam Mohammed', expertise: 'Hadith & Islamic History' },
                        { id: 3, name: 'Imam Fatima', expertise: "Women's Islamic Issues" }
                    ];
                    const select = document.getElementById('imamSelect');
                    select.innerHTML = '<option value="">-- Select an Imam --</option>' + 
                        availableImams.map(imam => `
                            <option value="${imam.id}">${imam.name} - ${imam.expertise}</option>
                        `).join('');
                }
            }
        }

        // Load user's conversations
        async function loadUserConversations() {
            const container = document.getElementById('myConversations');
            if (!container) {
                console.error('myConversations container not found');
                return;
            }
            container.innerHTML = '<p class="text-gray-400 italic">Loading conversations...</p>';
            try {
                console.log('Loading conversations for:', userEmail || 'guest@app.local');
                const response = await fetch(`${API_BASE_URL}/chat/conversations/${encodeURIComponent(userEmail || 'guest@app.local')}`);
                console.log('Conversations response status:', response.status);
                if (response.ok) {
                    const conversations = await response.json();
                    console.log('Conversations received:', conversations.length);
                    if (conversations.length === 0) {
                        container.innerHTML = '<p class="text-gray-400 italic">No conversations yet. Start a new conversation with an Imam!</p>';
                    } else {
                        container.innerHTML = conversations.map(conv => `
                            <div onclick="openConversation(${conv.id}, '${escapeHtml(conv.imam_name)}', '${escapeHtml(conv.topic)}')" 
                                 class="bg-gray-800/50 rounded-lg p-4 cursor-pointer hover:bg-gray-700/50 border-l-4 ${conv.unread_count > 0 ? 'border-ramadan-gold' : 'border-purple-500'} transition-all duration-200">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-bold text-purple-400">ğŸ•Œ ${escapeHtml(conv.imam_name)}</h4>
                                        <p class="text-gray-300">${escapeHtml(conv.topic)}</p>
                                        <p class="text-xs text-gray-500 mt-1">Last updated: ${new Date(conv.updated_at).toLocaleString()}</p>
                                    </div>
                                    <div class="text-right">
                                        ${conv.unread_count > 0 ? `<span class="bg-ramadan-gold text-ramadan-night px-2 py-1 rounded-full text-xs font-bold">${conv.unread_count} new</span>` : ''}
                                        <span class="text-purple-400 text-2xl block mt-2">ğŸ’¬</span>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    throw new Error('Backend offline');
                }
            } catch (error) {
                console.warn('loadUserConversations error:', error.message);
                // Only show demo mode for actual network failures
                if (error instanceof TypeError || error.message === 'Failed to fetch') {
                    container.innerHTML = `
                        <div class="bg-purple-900/30 border-2 border-purple-500/30 rounded-lg p-4">
                            <p class="text-purple-400 font-semibold">ğŸ”¹ Demo Mode</p>
                            <p class="text-gray-400 text-sm mt-1">Chat with Imam requires the backend server. Start a conversation to see how it works!</p>
                        </div>`;
                } else {
                    container.innerHTML = `
                        <div class="bg-red-900/30 border-2 border-red-500/30 rounded-lg p-4">
                            <p class="text-red-400 font-semibold">âš ï¸ Error Loading Conversations</p>
                            <p class="text-gray-400 text-sm mt-1">${error.message}</p>
                        </div>`;
                }
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load conversations for imam
        async function loadImamConversations() {
            const container = document.getElementById('imamConversationsList');
            const imamEmail = currentImam ? currentImam.email : null;
            
            if (!imamEmail) {
                container.innerHTML = '<p class="text-gray-400 italic">Please login as Imam to view conversations</p>';
                return;
            }
            
            try {
                // Get conversations for this specific imam
                const response = await fetch(`${API_BASE_URL}/chat/imam-conversations/${encodeURIComponent(imamEmail)}`);
                if (response.ok) {
                    const conversations = await response.json();
                    if (conversations.length === 0) {
                        container.innerHTML = '<div class="bg-gray-800/50 rounded-lg p-6 text-center"><p class="text-gray-400">No conversations yet. Users will be able to message you here.</p></div>';
                    } else {
                        container.innerHTML = conversations.map(conv => `
                            <div onclick="openImamConversation(${conv.id}, '${escapeHtml(conv.user_email)}', '${escapeHtml(conv.topic)}')" 
                                 class="bg-gray-800/50 rounded-lg p-4 cursor-pointer hover:bg-gray-700/50 border-l-4 ${conv.unread_count > 0 ? 'border-red-500' : 'border-purple-500'} transition-all duration-200">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-bold text-blue-400">ğŸ‘¤ ${escapeHtml(conv.user_email)}</h4>
                                        <p class="text-gray-300">${escapeHtml(conv.topic)}</p>
                                        ${conv.last_message ? `<p class="text-sm text-gray-500 mt-1 truncate">"${escapeHtml(conv.last_message)}..."</p>` : ''}
                                        <p class="text-xs text-gray-500 mt-1">Last updated: ${new Date(conv.updated_at).toLocaleString()}</p>
                                    </div>
                                    <div class="text-right">
                                        ${conv.unread_count > 0 ? `<span class="bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold animate-pulse">${conv.unread_count} new</span>` : ''}
                                        <span class="text-blue-400 text-2xl block mt-2">ğŸ’¬</span>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                container.innerHTML = '<p class="text-red-400">Error loading conversations</p>';
            }
        }

        function showNewConversationForm() {
            document.getElementById('newConversationForm').classList.remove('hidden');
            document.getElementById('newConvoBtn').classList.add('hidden');
        }

        function hideNewConversationForm() {
            document.getElementById('newConversationForm').classList.add('hidden');
            document.getElementById('newConvoBtn').classList.remove('hidden');
        }

        // Start a new conversation
        async function startConversation() {
            const imamId = document.getElementById('imamSelect').value;
            const topic = document.getElementById('conversationTopic').value.trim();
            const message = document.getElementById('initialMessage').value.trim();

            if (!imamId) { alert('Please select an Imam'); return; }
            if (!topic) { alert('Please enter a topic'); return; }
            if (!message) { alert('Please write your initial message'); return; }

            try {
                // Create conversation
                const convResponse = await fetch(`${API_BASE_URL}/chat/conversations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_email: userEmail || 'guest@app.local',
                        imam_id: parseInt(imamId),
                        topic: topic
                    })
                });

                if (convResponse.ok) {
                    const conv = await convResponse.json();
                    
                    // Send initial message
                    await fetch(`${API_BASE_URL}/chat/messages`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            conversation_id: conv.id,
                            sender_email: userEmail || 'guest@app.local',
                            sender_type: 'user',
                            message_text: message
                        })
                    });

                    // Clear form and reload
                    document.getElementById('conversationTopic').value = '';
                    document.getElementById('initialMessage').value = '';
                    document.getElementById('imamSelect').value = '';
                    hideNewConversationForm();
                    loadUserConversations();

                    // Open the new conversation
                    const imam = availableImams.find(i => i.id === parseInt(imamId));
                    openConversation(conv.id, imam ? imam.name : 'Imam', topic);
                } else {
                    throw new Error('Backend offline');
                }
            } catch (error) {
                console.warn('Send message error:', error.message);
                // Only show demo mode for actual network failures
                if (error instanceof TypeError || error.message === 'Failed to fetch') {
                    // Demo mode - show demo conversation
                    const imam = availableImams.find(i => i.id === parseInt(imamId));
                    document.getElementById('conversationTopic').value = '';
                    document.getElementById('initialMessage').value = '';
                    document.getElementById('imamSelect').value = '';
                    hideNewConversationForm();
                    
                    currentConversationId = 'demo';
                    document.getElementById('chatImamName').textContent = 'ğŸ•Œ ' + (imam ? imam.name : 'Imam');
                    document.getElementById('chatTopic').textContent = topic;
                    document.getElementById('conversationsList').classList.add('hidden');
                    document.getElementById('newConversationForm').classList.add('hidden');
                    document.getElementById('chatInterface').classList.remove('hidden');
                    
                    // Show demo messages
                    const container = document.getElementById('messagesContainer');
                    container.innerHTML = `
                        <div class="mb-4 text-right">
                            <div class="inline-block max-w-xs lg:max-w-md px-4 py-3 rounded-lg bg-purple-600 text-white">
                                <p class="text-sm">${message}</p>
                                <p class="text-xs mt-1 text-purple-200">${new Date().toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="mb-4 text-left">
                            <div class="inline-block max-w-xs lg:max-w-md px-4 py-3 rounded-lg bg-white shadow border border-gray-200 text-gray-800">
                                <p class="text-sm">ğŸ”¹ <strong>Backend Offline:</strong> This is a demonstration of the Chat with Imam feature. Start the backend server for the full experience.</p>
                                <p class="text-xs mt-1 text-gray-400">${new Date().toLocaleString()}</p>
                            </div>
                        </div>
                    `;
                } else {
                    // Show error message
                    alert(`Error: ${error.message}`);
                }
            }
        }

        // Open user conversation
        async function openConversation(conversationId, imamName, topic) {
            currentConversationId = conversationId;
            document.getElementById('chatImamName').textContent = 'ğŸ•Œ ' + imamName;
            document.getElementById('chatTopic').textContent = topic;
            
            document.getElementById('conversationsList').classList.add('hidden');
            document.getElementById('newConversationForm').classList.add('hidden');
            document.getElementById('chatInterface').classList.remove('hidden');

            await loadMessages(conversationId, 'messagesContainer');
        }

        // Open imam conversation
        async function openImamConversation(conversationId, userEmail, topic) {
            currentConversationId = conversationId;
            document.getElementById('imamChatUserEmail').textContent = 'ğŸ‘¤ ' + userEmail;
            document.getElementById('imamChatTopic').textContent = topic;
            
            document.getElementById('imamConversationsList').classList.add('hidden');
            document.getElementById('imamChatInterface').classList.remove('hidden');

            await loadMessages(conversationId, 'imamMessagesContainer');
        }

        // Load messages for a conversation
        async function loadMessages(conversationId, containerId) {
            const container = document.getElementById(containerId);
            try {
                const response = await fetch(`${API_BASE_URL}/chat/messages/${conversationId}`);
                if (response.ok) {
                    const data = await response.json();
                    const messages = data.messages || [];
                    if (messages.length === 0) {
                        container.innerHTML = '<p class="text-gray-400 text-center italic">No messages yet. Start the conversation!</p>';
                    } else {
                        container.innerHTML = messages.map(msg => `
                            <div class="mb-4 ${msg.sender_type === 'user' ? 'text-right' : 'text-left'}">
                                <div class="inline-block max-w-xs lg:max-w-md px-4 py-3 rounded-lg ${
                                    msg.sender_type === 'user' 
                                        ? 'bg-purple-600 text-white' 
                                        : 'bg-gray-700 border border-gray-600 text-gray-200'
                                }">
                                    <p class="text-sm">${escapeHtml(msg.message_text)}</p>
                                    <p class="text-xs mt-1 ${msg.sender_type === 'user' ? 'text-purple-200' : 'text-gray-400'}">
                                        ${new Date(msg.created_at).toLocaleString()}
                                    </p>
                                </div>
                            </div>
                        `).join('');
                    }
                    container.scrollTop = container.scrollHeight;
                } else {
                    throw new Error('Failed to load messages');
                }
            } catch (error) {
                container.innerHTML = '<p class="text-red-400 text-center">Error loading messages. Please try again.</p>';
                console.error('Error loading messages:', error);
            }
        }

        // Send message as user
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message || !currentConversationId) return;

            try {
                await fetch(`${API_BASE_URL}/chat/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        sender_email: userEmail || 'guest@app.local',
                        sender_type: 'user',
                        message_text: message
                    })
                });
                input.value = '';
                await loadMessages(currentConversationId, 'messagesContainer');
            } catch (error) {
                alert('Error sending message');
            }
        }

        // Send message as imam
        async function sendImamMessage() {
            const input = document.getElementById('imamMessageInput');
            const message = input.value.trim();
            if (!message || !currentConversationId) return;

            try {
                await fetch(`${API_BASE_URL}/chat/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        sender_email: currentImam.email,
                        sender_type: 'imam',
                        message_text: message
                    })
                });
                input.value = '';
                await loadMessages(currentConversationId, 'imamMessagesContainer');
            } catch (error) {
                alert('Error sending message');
            }
        }

        function closeChat() {
            document.getElementById('chatInterface').classList.add('hidden');
            document.getElementById('conversationsList').classList.remove('hidden');
            document.getElementById('newConvoBtn').classList.remove('hidden');
            currentConversationId = null;
            loadUserConversations();
        }

        function closeImamChat() {
            document.getElementById('imamChatInterface').classList.add('hidden');
            document.getElementById('imamConversationsList').classList.remove('hidden');
            currentConversationId = null;
            loadImamConversations();
        }

        // ==================== EVENTS FUNCTIONALITY ====================
        let eventsData = [];
        let citiesList = [];

        // Load Tunisia cities for dropdowns
        async function loadCities() {
            try {
                const response = await fetch(`${API_BASE_URL}/events/cities`);
                if (response.ok) {
                    const data = await response.json();
                    citiesList = data.cities || data;  // Handle both {cities:[...]} and [...] formats
                    const filterSelect = document.getElementById('eventCityFilter');
                    const formSelect = document.getElementById('eventCity');
                    
                    // Populate filter dropdown
                    if (filterSelect) {
                        filterSelect.innerHTML = '<option value="">ğŸ™ï¸ All Cities</option>' + 
                            citiesList.map(city => `<option value="${city}">${city}</option>`).join('');
                    }
                    
                    // Populate form dropdown
                    if (formSelect) {
                        formSelect.innerHTML = '<option value="">Select City</option>' + 
                            citiesList.map(city => `<option value="${city}">${city}</option>`).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading cities:', error);
            }
        }

        // Load events from API
        async function loadEvents() {
            const container = document.getElementById('eventsContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="col-span-full text-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-ramadan-gold mx-auto"></div><p class="text-gray-400 mt-4">Loading events...</p></div>';
            
            try {
                const cityFilter = document.getElementById('eventCityFilter')?.value || '';
                const categoryFilter = document.getElementById('eventCategoryFilter')?.value || '';
                
                let url = `${API_BASE_URL}/events?`;
                if (cityFilter) url += `city=${encodeURIComponent(cityFilter)}&`;
                if (categoryFilter) url += `category=${encodeURIComponent(categoryFilter)}`;
                
                const response = await fetch(url);
                if (response.ok) {
                    eventsData = await response.json();
                    renderEvents();
                } else {
                    container.innerHTML = '<div class="col-span-full text-center py-8 text-red-400">Error loading events</div>';
                }
            } catch (error) {
                console.error('Error loading events:', error);
                container.innerHTML = '<div class="col-span-full text-center py-8 text-red-400">Unable to connect to server</div>';
            }
        }

        // Render events cards
        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            if (!container) return;
            
            if (eventsData.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <p class="text-6xl mb-4">ğŸŒ™</p>
                        <p class="text-gray-400 text-lg">No events found</p>
                        <p class="text-gray-500 text-sm mt-2">Be the first to post an Islamic event in Tunisia!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = eventsData.map(event => renderEventCard(event)).join('');
        }

        // Render single event card
        function renderEventCard(event) {
            const categoryEmojis = {
                'Iftar': 'ğŸ½ï¸',
                'Taraweeh': 'ğŸ•Œ',
                'Lecture': 'ğŸ“š',
                'Charity': 'ğŸ’',
                'Quran Study': 'ğŸ“–',
                'Community': 'ğŸ‘¥',
                'Youth': 'ğŸŒŸ',
                'Sisters': 'ğŸ‘©',
                'Family': 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦',
                'Sports': 'âš½',
                'Other': 'âœ¨'
            };
            
            const emoji = categoryEmojis[event.category] || 'âœ¨';
            const isFeatured = event.is_featured;
            const eventDate = new Date(event.event_date);
            const formattedDate = eventDate.toLocaleDateString('en-US', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
            
            return `
                <div class="bg-gray-800/50 rounded-xl overflow-hidden border ${isFeatured ? 'border-ramadan-gold ring-2 ring-ramadan-gold/30' : 'border-gray-700'} hover:border-ramadan-gold/50 transition-all duration-300">
                    ${isFeatured ? '<div class="bg-gradient-to-r from-ramadan-gold to-yellow-500 text-ramadan-night text-xs font-bold py-1 px-3 text-center">â­ FEATURED EVENT</div>' : ''}
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-4">
                            <span class="text-3xl">${emoji}</span>
                            <span class="text-xs bg-ramadan-purple/30 text-ramadan-gold px-2 py-1 rounded-full">${event.category}</span>
                        </div>
                        <h3 class="text-lg font-semibold text-white mb-2">${event.title}</h3>
                        <p class="text-gray-400 text-sm mb-4 line-clamp-2">${event.description || 'No description provided'}</p>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center text-gray-300">
                                <span class="mr-2">ğŸ“</span>
                                <span>${event.city}</span>
                            </div>
                            <div class="flex items-center text-gray-300">
                                <span class="mr-2">ğŸ“…</span>
                                <span>${formattedDate}</span>
                            </div>
                            <div class="flex items-center text-gray-300">
                                <span class="mr-2">â°</span>
                                <span>${event.event_time || 'Time TBA'}</span>
                            </div>
                            ${event.location ? `
                            <div class="flex items-center text-gray-300">
                                <span class="mr-2">ğŸ›ï¸</span>
                                <span class="truncate">${event.location}</span>
                            </div>
                            ` : ''}
                        </div>
                        ${event.contact_info ? `
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <p class="text-xs text-gray-500">Contact: ${event.contact_info}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Filter events
        function filterEvents() {
            loadEvents();
        }

        // Show post event modal
        function showPostEventModal() {
            if (!currentUser) {
                alert('Please login to post an event');
                showLogin();
                return;
            }
            document.getElementById('postEventModal').classList.remove('hidden');
        }

        // Hide post event modal
        function hidePostEventModal() {
            document.getElementById('postEventModal').classList.add('hidden');
            document.getElementById('postEventForm').reset();
        }

        // Submit new event
        async function submitEvent(e) {
            if (e) e.preventDefault();
            
            if (!authToken) {
                alert('Please login to post an event');
                return;
            }
            
            // Find the submit button - works for both onclick and form submit
            const submitBtn = document.querySelector('#postEventModal button[onclick*="submitEvent"]') || 
                              (e && e.target && e.target.querySelector('button[type="submit"]'));
            
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="animate-spin">â³</span> Posting...';
            }
            
            // Get form values - match actual form field IDs
            const formData = {
                title: document.getElementById('eventTitle').value,
                description: document.getElementById('eventDescription').value,
                city: document.getElementById('eventCity').value,
                location: document.getElementById('eventLocation').value,
                event_date: document.getElementById('eventDate').value,
                event_time: document.getElementById('eventTime').value,
                category: document.getElementById('eventCategory').value,
                contact_info: document.getElementById('eventPhone').value || '',  // Form uses eventPhone
                is_featured: document.getElementById('eventListingType').value === 'featured'  // Form uses eventListingType
            };
            
            // Validate required fields
            if (!formData.title || !formData.city || !formData.event_date) {
                alert('Please fill in Title, City, and Date');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'ğŸ“¤ Submit Event';
                }
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/events`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('âœ… Event posted successfully!' + (formData.is_featured ? '\nâ­ Featured listing active!' : ''));
                    hidePostEventModal();
                    loadEvents();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to post event'));
                }
            } catch (error) {
                console.error('Error posting event:', error);
                alert('Error connecting to server');
            } finally {
                if (submitBtn) {
                    submitBtn.innerHTML = 'ğŸ“¤ Submit Event';
                    submitBtn.disabled = false;
                }
            }
        }

        // Initialize events when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load cities for events
            loadCities();
            
            // Add event listener for post event form
            const postEventForm = document.getElementById('postEventForm');
            if (postEventForm) {
                postEventForm.addEventListener('submit', submitEvent);
            }
        });
    </script>
</body>
</html>
